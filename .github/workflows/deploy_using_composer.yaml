- name: Deploy with Docker Compose
  env:
    SERVER_HOST: ${{ secrets.AWS_SERVER_HOST }}
    SERVER_USER: ${{ secrets.AWS_SERVER_USER }}
    GHCR_TOKEN: ${{ secrets.GITHUB_TOKEN }}
  run: |
    ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no ${SERVER_USER}@${SERVER_HOST} << EOF

      set -e

      cd /opt/glatar

      echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin

      docker compose pull

      docker compose up -d --remove-orphans

      docker image prune -f

      docker compose ps

    EOF
